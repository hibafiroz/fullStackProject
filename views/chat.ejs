<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chat</title>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body
  class="bg-gradient-to-br from-black via-purple-950 to-black text-white font-sans flex flex-col items-center p-6 min-h-screen">
  <div class="relative flex items-center py-2 px-4 mt-5 w-full max-w-2xl 
            rounded-sm text-2xl bg-gradient-to-r from-purple-600 via-pink-500 to-purple-400 
            drop-shadow-[0_0_10px_rgba(168,85,247,0.8)] mx-auto">
    <a href="/student/studentList"
      class="absolute text-lg left-5 text-white font-medium hover:text-red-500 transition duration-300">
      <span class="text-4xl font-extrabold leading-none">‚ùÆ</span>

    </a>
    <div class="flex items-center justify-center gap-4 w-full">
      <a href="/student/profile">
        <img src="/photos/<%= photo %>" alt="Profile" class="w-10 h-10 rounded-full border-2 object-cover">
      </a>
      <h1 class="text-2xl font-bold text-white">
        <%= otherUser.username %>
      </h1>
    </div>
  </div>
  <br>
  <div id="chatBox"
    class="w-full max-w-2xl h-96 bg-black border border-purple-700 rounded-lg p-4 mb-4 overflow-y-auto flex flex-col gap-2">
  </div>
  <div class="w-full max-w-2xl flex gap-2">
    <input type="text" id="msgInput" placeholder="Type a message..."
      class="flex-1 p-2 rounded border border-purple-600 text-black focus:outline-none focus:ring-2 focus:ring-purple-800" />
    <button onclick="sendMessage()" class="bg-purple-700 hover:bg-purple-600 px-4 py-2 rounded font-semibold"> Send
    </button>
  </div>


  <script>
    const chatBox = document.getElementById("chatBox");
    const input = document.getElementById("msgInput");
    const socket = io()
    const room = "<%= roomName %>";
    console.log('Joined room:', room);
    const username = "<%= currentUser.username %>";

    socket.emit("joinPrivateRoom", room)
    socket.on("singleMessage", ({ from, msg }) => {
    appendMessage(msg, from === username ? "self" : "other")
    })

    function sendMessage() {
      console.log('ended send msg')
      const msg = input.value.trim()
      if (msg){
      socket.emit("singleMessage", { msg, from: username, room })
      }
      input.value = ""  
    }


    function appendMessage(message, type) {
      const p = document.createElement("p")
      p.textContent = message;
      p.className = `mb-1 px-2 py-1 rounded max-w-[70%] text-sm
         ${type === "self"? "bg-purple-700 text-white p-3 self-end ml-auto"
         : "bg-purple-700 text-white p-3 self-start"}`
         
      chatBox.appendChild(p)
      console.log('appendmsg:',message)
         console.log('type:',type)
      chatBox.scrollTop = chatBox.scrollHeight
    }

  </script>
</body>

</html>